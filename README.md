# 智能外呼用户画像系统

> 基于智能外呼通话数据的客户画像分析平台，支持满意度、情感、风险、沟通意愿四维度画像分析

## 目录

- [系统概述](#系统概述)
- [架构设计](#架构设计)
- [数据关系](#数据关系)
- [画像计算口径](#画像计算口径)
- [后端说明](#后端说明)
- [前端说明](#前端说明)
- [部署与启动](#部署与启动)
- [开发指南](#开发指南)

---

## 系统概述

### 项目背景

本系统是智能外呼平台的用户画像子系统，通过对外呼通话记录的清洗、分析和聚合，构建客户的多维度画像，帮助运营人员了解客户状态、识别风险客户、优化外呼策略。

### 核心功能

| 功能模块 | 描述 |
|---------|------|
| **数据同步** | 从线上 MySQL 同步通话记录到画像数据库 |
| **规则引擎分析** | 基于 ASR 文本进行满意度/情感/风险分析 |
| **画像聚合** | 按客户+场景+周期聚合计算画像快照 |
| **统计展示** | 4维度分布图表 + 趋势分析 + 明细列表 |

### 技术栈

| 层级 | 技术选型 |
|------|---------|
| **后端框架** | FastAPI + SQLAlchemy 2.0 (async) |
| **数据库** | PostgreSQL (画像库) + MySQL (源数据库, 只读) |
| **前端框架** | Vue 3 + TypeScript + Vite |
| **UI 组件** | Element Plus + ECharts |
| **容器化** | Docker + Docker Compose |

---

## 架构设计

### 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              智能外呼用户画像系统                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌──────────────┐      ETL 同步         ┌──────────────┐                       │
│   │              │ ───────────────────► │              │                       │
│   │  MySQL 源库   │   sync_call_records   │  PostgreSQL  │                       │
│   │ (线上业务数据) │ ◄─────────────────── │  (画像数据)   │                       │
│   │              │   get_asr_details     │              │                       │
│   └──────────────┘                       └──────┬───────┘                       │
│         │                                       │                               │
│         │ 通话记录                              │ 画像快照                        │
│         │ ASR 明细                              │ 场景汇总                        │
│         │                                       │                               │
│   ┌─────▼─────────────────────────────────────▼───────────────────┐            │
│   │                        后端服务 (FastAPI)                       │            │
│   ├───────────────────────────────────────────────────────────────┤            │
│   │                                                               │            │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │            │
│   │  │ ETL Service │  │Rule Engine  │  │ Portrait    │           │            │
│   │  │             │  │ Service     │  │ Service     │           │            │
│   │  │ - 数据同步   │  │ - 满意度分析│  │ - 快照聚合  │           │            │
│   │  │ - ASR 获取  │  │ - 情感分析  │  │ - 场景汇总  │           │            │
│   │  │             │  │ - 风险分析  │  │ - 趋势计算  │           │            │
│   │  └─────────────┘  └─────────────┘  └─────────────┘           │            │
│   │                                                               │            │
│   │  ┌────────────────────────────────────────────────────────┐  │            │
│   │  │                     REST API                            │  │            │
│   │  │  /task         /task/{id}/summary    /task/{id}/trend   │  │            │
│   │  │  /task/periods /task/{id}/customers  /admin/*           │  │            │
│   │  └────────────────────────────────────────────────────────┘  │            │
│   └───────────────────────────────────────────────────────────────┘            │
│                                       │                                         │
│                                       │ HTTP API                                │
│                                       ▼                                         │
│   ┌───────────────────────────────────────────────────────────────┐            │
│   │                       前端应用 (Vue 3)                         │            │
│   ├───────────────────────────────────────────────────────────────┤            │
│   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────────┐ │            │
│   │  │ 统计概览  │ │ 4维度分布 │ │ 趋势图表 │ │   明细列表       │ │            │
│   │  │ 客户/通话│ │  饼图×4  │ │ 折线图   │ │  筛选/分页/搜索  │ │            │
│   │  └──────────┘ └──────────┘ └──────────┘ └──────────────────┘ │            │
│   └───────────────────────────────────────────────────────────────┘            │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 服务调用关系图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              数据处理流程                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   1. ETL 数据同步                                                               │
│   ─────────────────────────────────────────────────────────────────────────     │
│                                                                                 │
│   ┌──────────────┐     ┌──────────────┐     ┌──────────────┐                   │
│   │   MySQL      │ ──► │  ETL Service │ ──► │ PostgreSQL   │                   │
│   │ call_record  │     │              │     │ call_record  │                   │
│   │ _2025_11     │     │ sync_call_   │     │ _enriched    │                   │
│   │              │     │ records()    │     │              │                   │
│   └──────────────┘     └──────┬───────┘     └──────────────┘                   │
│                               │                                                 │
│                               ▼                                                 │
│   2. ASR 分析                                                                   │
│   ─────────────────────────────────────────────────────────────────────────     │
│                                                                                 │
│   ┌──────────────┐     ┌──────────────┐     ┌──────────────┐                   │
│   │   MySQL      │ ──► │  ETL Service │ ──► │  Rule Engine │                   │
│   │ call_record  │     │              │     │              │                   │
│   │ _detail      │     │ batch_fetch_ │     │ analyze_call │                   │
│   │              │     │ asr_details()│     │ ()           │                   │
│   └──────────────┘     └──────────────┘     └──────┬───────┘                   │
│                                                     │                           │
│                                                     ▼                           │
│                                            ┌──────────────┐                    │
│                                            │ PostgreSQL   │                    │
│                                            │ call_record  │                    │
│                                            │ _enriched    │                    │
│                                            │ (更新分析字段)│                    │
│                                            └──────────────┘                    │
│                                                     │                           │
│                                                     ▼                           │
│   3. 画像聚合                                                                   │
│   ─────────────────────────────────────────────────────────────────────────     │
│                                                                                 │
│   ┌──────────────┐     ┌──────────────┐     ┌──────────────┐                   │
│   │ call_record  │ ──► │  Portrait    │ ──► │ user_portrait│                   │
│   │ _enriched    │     │  Service     │     │ _snapshot    │                   │
│   │              │     │              │     │              │                   │
│   │              │     │ compute_     │     │ (按customer+ │                   │
│   │              │     │ snapshot()   │     │ task+period) │                   │
│   └──────────────┘     └──────┬───────┘     └──────────────┘                   │
│                               │                                                 │
│                               ▼                                                 │
│   ┌──────────────┐     ┌──────────────┐                                        │
│   │ user_portrait│ ──► │ task_portrait│                                        │
│   │ _snapshot    │     │ _summary     │                                        │
│   │              │     │              │                                        │
│   │              │     │ (按task+     │                                        │
│   │              │     │  period)     │                                        │
│   └──────────────┘     └──────────────┘                                        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 数据关系

### ER 关系图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              MySQL 源数据库 (outbound_saas)                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌─────────────────────┐                                                       │
│   │   autodialer_task   │  任务/场景表                                          │
│   │─────────────────────│                                                       │
│   │ PK: uuid (char 36)  │◄──────────────────────────────┐                       │
│   │     name            │  场景名称                      │                       │
│   └─────────────────────┘                               │ 1:N                   │
│                                                          │                       │
│   ┌──────────────────────────────────┐                  │                       │
│   │ autodialer_call_record_2025_11   │  通话记录表 (按月分表)                    │
│   │──────────────────────────────────│                  │                       │
│   │ PK: id (char 36)                 │                  │                       │
│   │ FK: task_id ─────────────────────┼──────────────────┘                       │
│   │     customer_id ★ 画像主体       │◄─────────────────┐                       │
│   │     callee (手机号)              │                  │                       │
│   │     callid (通话唯一ID)          │                  │ 1:N                   │
│   │     calldate, duration, bill     │                  │                       │
│   │     rounds, hangup_disposition   │                  │                       │
│   └──────────────────────────────────┘                  │                       │
│                                                          │                       │
│   ┌──────────────────────────────────────────┐          │                       │
│   │ autodialer_call_record_detail_2025_11    │  ASR 明细表                      │
│   │──────────────────────────────────────────│          │                       │
│   │ PK: id                                   │          │                       │
│   │ FK: record_id ───────────────────────────┼──────────┘                       │
│   │     callid                               │                                  │
│   │     notify ★ 筛选条件                    │  'asrmessage_notify' = 有效交互  │
│   │     sequence (对话序号)                  │                                  │
│   │     question ★ 用户说的话                │                                  │
│   │     answer_text (ASR 标签)               │                                  │
│   │     answer_content (机器人回复)          │                                  │
│   └──────────────────────────────────────────┘                                  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

                                    │
                                    │ ETL 同步
                                    ▼

┌─────────────────────────────────────────────────────────────────────────────────┐
│                           PostgreSQL 画像数据库 (portrait)                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌───────────────────────────┐                                                 │
│   │    period_registry        │  周期注册表                                      │
│   │───────────────────────────│                                                 │
│   │ period_type: week/month   │                                                 │
│   │ period_key: 2025-W48      │                                                 │
│   │ status: completed         │                                                 │
│   └───────────────────────────┘                                                 │
│                                                                                 │
│   ┌───────────────────────────────────┐                                         │
│   │      call_record_enriched         │  增强通话记录 (明细层)                   │
│   │───────────────────────────────────│                                         │
│   │ callid                            │  ← MySQL call_record.callid            │
│   │ task_id                           │  ← MySQL call_record.task_id           │
│   │ user_id ★ customer_id             │  ← MySQL call_record.customer_id       │
│   │ phone                             │  ← MySQL call_record.callee            │
│   │ call_date, bill, rounds           │                                         │
│   │ ─────────────────────────         │                                         │
│   │ satisfaction ★ 满意度              │  ← 规则引擎分析                         │
│   │ sentiment ★ 情感                   │  ← 规则引擎分析                         │
│   │ complaint_risk ★ 投诉风险          │  ← 规则引擎分析                         │
│   │ churn_risk ★ 流失风险              │  ← 规则引擎分析                         │
│   │ willingness ★ 沟通意愿             │  ← 规则引擎分析                         │
│   │ risk_level ★ 综合风险              │  ← 规则引擎分析                         │
│   └────────────────┬──────────────────┘                                         │
│                    │ GROUP BY customer_id, task_id, period                      │
│                    ▼                                                            │
│   ┌───────────────────────────────────┐                                         │
│   │    user_portrait_snapshot         │  用户画像快照 (汇总层)                   │
│   │───────────────────────────────────│                                         │
│   │ UK: customer_id + task_id +       │                                         │
│   │     period_type + period_key      │                                         │
│   │ ─────────────────────────         │                                         │
│   │ total_calls, connected_calls      │  通话统计                               │
│   │ avg_duration, avg_rounds          │                                         │
│   │ ─────────────────────────         │                                         │
│   │ final_satisfaction ★              │  综合满意度 (最后一次有效)               │
│   │ final_emotion ★                   │  综合情感 (负面优先)                     │
│   │ risk_level ★                      │  综合风险 (高优先)                       │
│   │ willingness ★                     │  综合沟通意愿                           │
│   └────────────────┬──────────────────┘                                         │
│                    │ GROUP BY task_id, period                                   │
│                    ▼                                                            │
│   ┌───────────────────────────────────┐                                         │
│   │    task_portrait_summary          │  场景画像汇总 (报表层)                   │
│   │───────────────────────────────────│                                         │
│   │ UK: task_id + period_type +       │                                         │
│   │     period_key                    │                                         │
│   │ task_name                         │  ← MySQL autodialer_task.name          │
│   │ ─────────────────────────         │                                         │
│   │ total_customers, total_calls      │  基础统计                               │
│   │ ─────────────────────────         │                                         │
│   │ satisfied_rate ★                  │  满意度趋势分子                         │
│   │ high_risk_rate ★                  │  风险趋势分子                           │
│   │ positive_rate ★                   │  情感趋势分子                           │
│   │ deep_willingness_rate ★           │  沟通意愿趋势分子                       │
│   └───────────────────────────────────┘                                         │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 聚合维度说明

| 层级 | 表名 | 聚合维度 | 用途 |
|------|------|---------|------|
| 明细层 | `call_record_enriched` | 每通电话 | 规则引擎分析输入 |
| 汇总层 | `user_portrait_snapshot` | `customer_id + task_id + period` | 客户明细列表展示 |
| 报表层 | `task_portrait_summary` | `task_id + period` | 统计卡片、分布图、趋势图 |

---

## 画像计算口径

### 四维度画像体系

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              用户画像四维度                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌────────────┐│
│   │    满意度        │  │     风险        │  │     情感        │  │ 沟通意愿   ││
│   │  Satisfaction   │  │     Risk        │  │    Emotion      │  │ Willingness││
│   ├─────────────────┤  ├─────────────────┤  ├─────────────────┤  ├────────────┤│
│   │ • 满意 satisfied│  │ • 流失 churn    │  │ • 正向 positive │  │ • 深度     ││
│   │ • 一般 neutral  │  │ • 投诉 complaint│  │ • 中性 neutral  │  │ • 一般     ││
│   │ • 不满意        │  │ • 一般 medium   │  │ • 负向 negative │  │ • 较低     ││
│   │   unsatisfied   │  │ • 无风险 none   │  │                 │  │            ││
│   └─────────────────┘  └─────────────────┘  └─────────────────┘  └────────────┘│
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 1. 满意度 (Satisfaction)

**数据来源优先级**: ASR 标签 > 用户打分 > 关键词匹配

```python
# 1. ASR 标签识别 (最高优先级)
SATISFACTION_ASR_TAGS = {
    'satisfied': ['满分', 'Q7-满分', 'Q9-满分', '非常满意', '很满意'],
    'unsatisfied': ['非满分', 'Q7-非满分', '不满意', '非常不满意'],
    'neutral': ['一般', 'Q8', 'default', '还可以'],
}

# 2. 用户打分识别 (正则匹配)
SCORE_PATTERNS = {
    'satisfied': [r'10分', r'十分', r'9分', r'九分', r'满分'],
    'neutral': [r'8分', r'八分', r'7分', r'七分', r'6分'],
    'unsatisfied': [r'[0-5]分', r'零分', r'一分', r'两分'],
}

# 3. 关键词匹配 (兜底)
SATISFACTION_KEYWORDS = {
    'satisfied': ['满意', '很好', '不错', '谢谢', '解决了', '处理好了'],
    'unsatisfied': ['不满意', '不好', '差', '没解决', '失望'],
    'neutral': ['一般', '还行', '凑合', '马马虎虎'],
}
```

**多通电话综合规则**: 取最后一次有效评分

### 2. 风险 (Risk)

**综合风险等级判定**:

```
if churn_risk == 'high':     → 流失风险 (churn)
elif complaint_risk == 'high': → 投诉风险 (complaint)
elif any == 'medium':        → 一般 (medium)
else:                        → 无风险 (none)
```

**投诉风险关键词**:

| 等级 | 关键词示例 |
|------|-----------|
| high | 投诉、举报、工信部、12315、骗人、垃圾、找领导、起诉、律师 |
| medium | 不满意、太差、故障、没解决、乱收费、态度差、失望 |

**流失风险关键词**:

| 等级 | 关键词示例 |
|------|-----------|
| high | 不用了、取消、退订、销户、换运营商、携号转网、换套餐 |
| medium | 考虑、太贵、划不来、很少用、别家 |

**升级规则**: 命中 ≥3 个 medium 关键词 → 升级为 high

**多通电话综合规则**: 高风险优先

### 3. 情感 (Emotion)

**情感关键词**:

| 类型 | 关键词示例 |
|------|-----------|
| positive | 好、谢谢、满意、不错、解决了、专业、耐心 |
| negative | 差、烦、投诉、问题、故障、骗、垃圾、失望 |
| neutral | 哦、嗯、知道了、好吧、行吧 |

**判定规则**:
```python
if negative_count > 0:   → negative  # 负面优先
elif positive_count > 0: → positive
else:                    → neutral
```

**多通电话综合规则**: 负面优先（有一次负面就算负面）

### 4. 沟通意愿 (Willingness)

**判定规则**:

| 等级 | 判定条件 |
|------|---------|
| 深度 | 通话时长 > 60秒 **或** 交互轮次 > 5 |
| 较低 | 通话时长 < 20秒 **且** 交互轮次 < 3 |
| 一般 | 其他情况 |

**多通电话综合规则**: 基于平均通话时长和平均交互轮次

### 趋势指标计算口径

| 趋势维度 | 分子 | 分母 | 说明 |
|---------|------|------|------|
| 满意度趋势 | satisfied 客户数 | 有满意度数据的客户总数 | 满意比例 |
| 风险趋势 | churn + complaint 客户数 | 总客户数 | 高风险比例 |
| 情感趋势 | positive 客户数 | 有情感数据的客户总数 | 正向比例 |
| 沟通意愿趋势 | 深度沟通客户数 | 总客户数 | 深度沟通比例 |

---

## 后端说明

### 项目结构

```
src/
├── api/                    # API 层
│   └── v1/
│       ├── task.py         # 场景/任务相关接口
│       ├── admin.py        # 管理接口
│       └── periods.py      # 周期接口
├── core/
│   ├── config.py           # 配置管理
│   └── database.py         # 数据库连接
├── models/                 # 数据模型
│   └── portrait/
│       ├── call_enriched.py   # 增强通话记录
│       ├── snapshot.py        # 用户画像快照
│       └── task_summary.py    # 场景画像汇总
├── services/               # 业务服务
│   ├── etl_service.py         # ETL 数据同步
│   ├── rule_engine_service.py # 规则引擎分析
│   ├── portrait_service.py    # 画像计算
│   └── period_service.py      # 周期管理
├── schemas/                # Pydantic 模型
│   └── response.py
├── tasks/
│   └── scheduler.py        # 定时任务
└── main.py                 # 应用入口
```

### API 接口列表

#### 场景/任务接口

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/v1/task/periods` | GET | 获取可用周期列表 |
| `/api/v1/task` | GET | 获取场景列表（支持按周期筛选） |
| `/api/v1/task/{id}/summary` | GET | 获取场景统计汇总 |
| `/api/v1/task/{id}/trend` | GET | 获取场景趋势数据 |
| `/api/v1/task/{id}/customers` | GET | 获取客户明细列表（支持筛选） |

#### 管理接口

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/v1/admin/status` | GET | 系统状态 |
| `/api/v1/admin/sync` | POST | 手动触发数据同步 |
| `/api/v1/admin/compute` | POST | 手动触发画像计算 |
| `/api/v1/admin/sync-task-names` | POST | 同步场景名称 |

### 服务模块说明

#### ETL Service (`etl_service.py`)

```python
class ETLService:
    """数据同步服务"""
    
    async def sync_call_records(target_date: date) -> dict:
        """
        同步指定日期的通话记录
        1. 从 MySQL 读取通话记录
        2. 写入 PostgreSQL call_record_enriched
        3. 获取 ASR 详情并调用规则引擎分析
        """
    
    async def analyze_call_records(target_date: date) -> int:
        """
        分析指定日期的通话记录
        1. 批量获取 ASR 详情
        2. 调用规则引擎分析
        3. 批量更新分析结果
        """
```

#### Rule Engine Service (`rule_engine_service.py`)

```python
class RuleEngineService:
    """规则引擎服务 - 基于关键词和规则进行分析"""
    
    def analyze_call(
        user_text: str,
        asr_labels: list[str],
        duration: int,
        rounds: int
    ) -> AnalysisResult:
        """
        分析单通电话
        返回: satisfaction, emotion, complaint_risk, churn_risk, willingness, risk_level
        """
    
    def aggregate_multi_calls(call_results: list[dict]) -> dict:
        """
        多通电话综合规则
        - 满意度：取最后一次有效评分
        - 情感：负面优先
        - 风险：高优先
        - 沟通意愿：基于平均值
        """
```

#### Portrait Service (`portrait_service.py`)

```python
class PortraitService:
    """画像计算服务"""
    
    async def compute_snapshot(period_type: str, period_key: str) -> dict:
        """
        计算用户画像快照
        1. 按 (customer_id, task_id) 聚合 call_record_enriched
        2. 应用多通电话综合规则
        3. 批量 UPSERT 到 user_portrait_snapshot
        """
    
    async def compute_task_summary(period_type: str, period_key: str) -> dict:
        """
        计算场景画像汇总
        1. 按 task_id 聚合 user_portrait_snapshot
        2. 计算各维度占比
        3. UPSERT 到 task_portrait_summary
        """
```

### 定时任务配置

| 任务 | 默认时间 | 功能 |
|------|---------|------|
| 数据同步 | 02:00 | 同步前一天通话记录 + ASR 分析 |
| 画像计算 | 06:00 | 计算周/月/季度快照和汇总 |

配置方式:
```env
SCHEDULER_ENABLED=true
SYNC_CRON_HOUR=2
SYNC_CRON_MINUTE=0
```

---

## 前端说明

### 项目结构

```
web/
├── src/
│   ├── api/
│   │   └── index.ts        # API 封装
│   ├── types/
│   │   └── index.ts        # TypeScript 类型定义
│   ├── views/
│   │   └── PortraitDashboard.vue  # 主页面
│   ├── App.vue
│   └── main.ts
├── package.json
└── vite.config.ts
```

### 页面功能模块

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│  人群画像统计与分析                                                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌────────────────────────────────────────────────────────────────────────────┐│
│  │ 筛选条: [选择场景 ▼] [选择周 ▼] [刷新]                                      ││
│  └────────────────────────────────────────────────────────────────────────────┘│
│                                                                                 │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                            │
│  │  总客户数     │ │  总通话数     │ │  平均时长     │   ← 统计概览卡片           │
│  │    4,284     │ │    5,120     │ │    45.5秒    │                            │
│  └──────────────┘ └──────────────┘ └──────────────┘                            │
│                                                                                 │
│  ┌────────────────────────────────────────────────────────────────────────────┐│
│  │ 满意度分布 │ 风险分布 │ 情感分布 │ 沟通意愿分布 │   ← 4维度分布饼图           ││
│  │   [饼图]   │  [饼图]  │  [饼图]  │    [饼图]    │                            ││
│  └────────────────────────────────────────────────────────────────────────────┘│
│                                                                                 │
│  ┌────────────────────────────────────────────────────────────────────────────┐│
│  │ 画像趋势变化（4个维度）                           [最近4周 ▼]                ││
│  │ ┌────────────────────────────────────────────────────────────────────────┐││
│  │ │                          [折线图]                                      │││
│  │ │  ── 满意度  ── 风险  ── 正向情感  ── 深度沟通                          │││
│  │ └────────────────────────────────────────────────────────────────────────┘││
│  └────────────────────────────────────────────────────────────────────────────┘│
│                                                                                 │
│  ┌────────────────────────────────────────────────────────────────────────────┐│
│  │ 用户画像明细列表                                                           ││
│  │ ┌────────────────────────────────────────────────────────────────────────┐││
│  │ │ [手机号搜索] [满意度 ▼] [情感 ▼] [风险 ▼] [沟通意愿 ▼]   ← 筛选器        │││
│  │ └────────────────────────────────────────────────────────────────────────┘││
│  │ ┌────────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┐││
│  │ │ 客户ID │ 手机号  │ 场景   │ 通话数 │ 平均时长│ 满意度 │ 情感   │ 风险   │ 沟通意愿 │││
│  │ ├────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┤││
│  │ │ ...    │ ...    │ ...    │ ...    │ ...    │ 满意   │ 正向   │ 无风险 │ 深度   │││
│  │ └────────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┘││
│  │                                           [< 1 2 3 ... >]   ← 分页         ││
│  └────────────────────────────────────────────────────────────────────────────┘│
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### API 调用流程

```typescript
// 1. 初始化加载
onMounted(async () => {
  await loadAvailablePeriods()  // GET /task/periods
  await loadTasks()              // GET /task?period_key=xxx
  await loadData()               // 并行加载汇总、趋势、客户列表
})

// 2. 加载汇总数据
async function loadSummary() {
  // GET /task/{id}/summary?period_type=week&period_key=2025-W48
}

// 3. 加载趋势数据 (4个维度)
async function loadTrends() {
  await Promise.all([
    fetchTaskTrend(taskId, 'week', 'satisfied_rate', limit),
    fetchTaskTrend(taskId, 'week', 'high_risk_rate', limit),
    fetchTaskTrend(taskId, 'week', 'positive_rate', limit),
    fetchTaskTrend(taskId, 'week', 'deep_willingness_rate', limit),
  ])
}

// 4. 加载客户列表 (支持筛选)
async function loadCustomers() {
  // GET /task/{id}/customers?period_type=week&period_key=2025-W48
  //     &phone=xxx&satisfaction=satisfied&emotion=positive
  //     &risk_level=none&willingness=深度
}
```

### 关键组件说明

| 组件 | 功能 | 数据来源 |
|------|------|---------|
| 统计概览卡片 | 显示总客户/通话/时长 | `/task/{id}/summary` |
| 4维度分布饼图 | 各维度占比可视化 | `/task/{id}/summary` |
| 趋势折线图 | 4维度趋势变化 | `/task/{id}/trend` × 4 |
| 明细列表 | 客户画像详情 + 筛选 | `/task/{id}/customers` |

---

## 部署与启动

### 环境要求

- Python 3.11+
- Node.js 18+
- Docker & Docker Compose

### 快速启动

```bash
# 1. 启动数据库
docker-compose up -d portrait-postgres source-mysql

# 2. 启动后端
cd /path/to/project
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
uvicorn src.main:app --host 0.0.0.0 --port 8000

# 3. 启动前端
cd web
npm install
npm run dev
```

### 一键启动脚本

```bash
# 启动所有服务
sh scripts/start_all.sh

# 停止所有服务
sh scripts/stop_all.sh
```

### 数据重建

```bash
# 清空画像数据并重新计算
PYTHONPATH=. python scripts/rebuild_data.py
```

### 环境变量配置

```env
# PostgreSQL (画像存储)
PORTRAIT_DB_HOST=localhost
PORTRAIT_DB_PORT=5432
PORTRAIT_DB_USER=portrait
PORTRAIT_DB_PASSWORD=portrait123
PORTRAIT_DB_NAME=portrait

# MySQL (源数据，只读)
SOURCE_DB_HOST=localhost
SOURCE_DB_PORT=3306
SOURCE_DB_USER=readonly
SOURCE_DB_PASSWORD=xxx
SOURCE_DB_NAME=outbound_saas

# 调度器
SCHEDULER_ENABLED=true
```

---

## 开发指南

### 添加新的画像维度

1. **更新规则引擎** (`src/services/rule_engine_service.py`)
   - 添加关键词库
   - 实现分析方法
   - 更新 `AnalysisResult` 数据类

2. **更新数据模型**
   - `call_record_enriched`: 添加明细字段
   - `user_portrait_snapshot`: 添加汇总字段
   - `task_portrait_summary`: 添加报表字段

3. **更新服务层**
   - `etl_service.py`: 更新批量更新 SQL
   - `portrait_service.py`: 更新聚合查询

4. **更新 API**
   - `task.py`: 更新响应模型和查询

5. **更新前端**
   - `types/index.ts`: 更新类型定义
   - `PortraitDashboard.vue`: 添加展示组件

### 代码规范

- 后端: PEP 8 + Black 格式化
- 前端: ESLint + Prettier
- 提交信息: Conventional Commits

### 测试

```bash
# 后端测试
pytest tests/

# 前端测试
cd web && npm run test
```

---

## 更新日志

### v1.0.0 (2025-12-16)

- ✅ 完成四维度画像体系（满意度、风险、情感、沟通意愿）
- ✅ 实现规则引擎分析（替代大模型，提升性能）
- ✅ 前端交互优化（场景优先、周期筛选、明细筛选）
- ✅ 趋势图支持4维度展示
- ✅ 数据重建脚本支持一键清洗

---

## 维护联系

如有问题，请联系项目维护人员。
